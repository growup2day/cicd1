name: Copy Changed Files to Destination

on:
  pull_request:
    branches:
      - pulltest
    types:
      - closed
  push:
    branches:
      - pulltest

jobs:
  sync_files:
    if: (github.event_name == 'push' && github.ref == 'refs/heads/pulltest') || 
        (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'pulltest' && github.event.pull_request.head.ref == 'test')
    runs-on: [self-hosted, windows]
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout pulltest branch
        uses: actions/checkout@v4
        with:
          ref: pulltest
          fetch-depth: 0

      - name: Verify Active Branch
        run: |
          $currentBranch = git branch --show-current
          Write-Host "Currently on branch: $currentBranch"
          if ($currentBranch -ne "pulltest") {
              Write-Host "Error: Not on pulltest branch!"
              exit 1
          }

      - name: Get Changed Files
        id: changed_files
        run: |
          # Get the changed files for push and merge scenarios
          if ($env:GITHUB_EVENT_NAME -eq "push") {
              $changedFiles = git diff --name-only --diff-filter=AM HEAD~1 HEAD
          } else {
              $changedFiles = git diff --name-only --diff-filter=AM $env:GITHUB_SHA $env:GITHUB_SHA~1
          }

          if (-Not $changedFiles) {
              Write-Host "No changed files detected."
              echo "files=[]" | Out-File -FilePath $env:GITHUB_ENV -Append
              exit 0
          }

          Write-Host "Changed Files:"
          Write-Host $changedFiles

          $changedFilesArray = $changedFiles -split "`r?`n" | Where-Object { $_ -ne "" } | ConvertTo-Json -Compress

          Write-Host "GitHub Actions Output: $changedFilesArray"

          echo "files=$changedFilesArray" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Copy Changed Files
        run: |
          $pathFile = "pathvariable.txt"
          if (-Not (Test-Path -Path $pathFile)) {
              Write-Host "Error: pathvariable.txt not found."
              exit 1
          }

          $content = Get-Content $pathFile
          $destinationPathLine = $content | Where-Object { $_ -like 'destination_path=*' }

          if (-Not $destinationPathLine) {
              Write-Host "Error: destination_path is not assigned in pathvariable.txt"
              exit 1
          }

          $destinationPath = $destinationPathLine.Split('=')[1].Trim()

          if ([string]::IsNullOrWhiteSpace($destinationPath)) {
              Write-Host "Error: destination_path is empty in pathvariable.txt"
              exit 1
          }

          Write-Host "Destination Path: $destinationPath"

          $jsonString = "$env:files"

          if ($jsonString -eq "[]") {
              Write-Host "No changed files detected. Skipping copy."
              exit 0
          }

          try {
              $files = $jsonString | ConvertFrom-Json
          } catch {
              Write-Host "Error: Failed to parse JSON. Raw Output: $jsonString"
              exit 1
          }

          $repoRoot = "$env:GITHUB_WORKSPACE"
          Set-Location -Path $repoRoot

          foreach ($file in $files) {
              $file = $file -replace '/', '\'
              $source = Join-Path -Path $repoRoot -ChildPath $file
              $destination = Join-Path -Path $destinationPath -ChildPath $file

              $destDir = Split-Path -Path $destination -Parent
              if (-Not (Test-Path -Path $destDir)) {
                  New-Item -ItemType Directory -Path $destDir -Force | Out-Null
              }

              if (Test-Path -Path $source) {
                  Copy-Item -Path $source -Destination $destination -Force
                  Write-Host "Copied: $file"
              } else {
                  Write-Host "Warning: Source file does not exist -> $source"
              }
          }

          Write-Host "File transfer completed successfully!"
